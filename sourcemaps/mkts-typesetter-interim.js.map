{"version":3,"sources":["mkts-typesetter-interim.coffee"],"names":[],"mappings":"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","file":"mkts-typesetter-interim.js","sourceRoot":"/source/","sourcesContent":["\n\n\n\n\n############################################################################################################\nnjs_path                  = require 'path'\nnjs_fs                    = require 'fs'\n#...........................................................................................................\nCND                       = require 'cnd'\nrpr                       = CND.rpr\nbadge                     = 'JIZURA/MKTS-interim'\nlog                       = CND.get_logger 'plain',     badge\ninfo                      = CND.get_logger 'info',      badge\nwhisper                   = CND.get_logger 'whisper',   badge\nalert                     = CND.get_logger 'alert',     badge\ndebug                     = CND.get_logger 'debug',     badge\nwarn                      = CND.get_logger 'warn',      badge\nhelp                      = CND.get_logger 'help',      badge\nurge                      = CND.get_logger 'urge',      badge\necho                      = CND.echo.bind CND\n#...........................................................................................................\nsuspend                   = require 'coffeenode-suspend'\nstep                      = suspend.step\n#...........................................................................................................\nD                         = require 'pipedreams'\n$                         = D.remit.bind D\n$async                    = D.remit_async.bind D\n#...........................................................................................................\nƒ                         = CND.format_number.bind CND\nTYPESETTER                = require 'mingkwai-typesetter'\nASYNC                     = require 'async'\n\n\n#-----------------------------------------------------------------------------------------------------------\noptions =\n  'pdf-command':          \"bin/pdf-from-tex.sh\"\n#...........................................................................................................\ndo ->\n  home                      = njs_path.join __dirname, '..'\n  options[ 'home' ]         = home\n  options[ 'tmp-home' ]     = njs_path.join home, 'tmp'\n  options[ 'pdf-command' ]  = njs_path.resolve home, options[ 'pdf-command' ]\n\n#-----------------------------------------------------------------------------------------------------------\nHELPERS = {}\n\n#-----------------------------------------------------------------------------------------------------------\nHELPERS.provide_tmp_folder = ->\n  njs_fs.mkdirSync options[ 'tmp-home' ] unless njs_fs.existsSync options[ 'tmp-home' ]\n  return null\n\n#-----------------------------------------------------------------------------------------------------------\nHELPERS.new_layout_info = ( source_route ) ->\n  pdf_command         = options[ 'pdf-command' ]\n  tmp_home            = options[ 'tmp-home' ]\n  source_locator      = njs_path.resolve process.cwd(), source_route\n  source_home         = njs_path.dirname source_locator\n  source_name         = njs_path.basename source_locator\n  tex_locator         = njs_path.join tmp_home, CND.swap_extension source_name, '.tex'\n  aux_locator         = njs_path.join tmp_home, CND.swap_extension source_name, '.aux'\n  pdf_source_locator  = njs_path.join tmp_home, CND.swap_extension source_name, '.pdf'\n  pdf_target_locator  = njs_path.join source_home, CND.swap_extension source_name, '.pdf'\n  #.........................................................................................................\n  R =\n    'pdf-command':          pdf_command\n    'tmp-home':             tmp_home\n    'source-route':         source_route\n    'source-locator':       source_locator\n    'source-home':          source_home\n    'source-name':          source_name\n    'tex-locator':          tex_locator\n    'aux-locator':          aux_locator\n    'pdf-source-locator':   pdf_source_locator\n    'pdf-target-locator':   pdf_target_locator\n    'latex-run-count':      0\n  #.........................................................................................................\n  return R\n\n#-----------------------------------------------------------------------------------------------------------\nHELPERS.write_pdf = ( layout_info, handler ) ->\n  #.........................................................................................................\n  pdf_command         = layout_info[ 'pdf-command'          ]\n  tmp_home            = layout_info[ 'tmp-home'             ]\n  tex_locator         = layout_info[ 'tex-locator'          ]\n  aux_locator         = layout_info[ 'aux-locator'          ]\n  pdf_source_locator  = layout_info[ 'pdf-source-locator'   ]\n  pdf_target_locator  = layout_info[ 'pdf-target-locator'   ]\n  last_digest         = null\n  last_digest         = CND.id_from_route aux_locator if njs_fs.existsSync aux_locator\n  digest              = null\n  count               = 0\n  #.........................................................................................................\n  pdf_from_tex = ( next ) =>\n    count += 1\n    urge \"run ##{count} #{pdf_command}\"\n    urge \"#{pdf_command}\"\n    urge \"$1: #{tmp_home}\"\n    urge \"$2: #{tex_locator}\"\n    CND.spawn pdf_command, [ tmp_home, tex_locator, ], ( error, data ) =>\n      error = undefined if error is 0\n      if error?\n        alert error\n        return handler error\n      digest = CND.id_from_route aux_locator\n      if digest is last_digest\n        echo ( CND.grey badge ), CND.lime \"done.\"\n        layout_info[ 'latex-run-count' ] = count\n        ### TAINT move pdf to layout_info[ 'source-home' ] ###\n        handler null\n      else\n        last_digest = digest\n        next()\n  #.........................................................................................................\n  ASYNC.forever pdf_from_tex\n\n\n#-----------------------------------------------------------------------------------------------------------\n@pdf_from_md = ( source_route, handler ) ->\n  ###\n  FI = require 'coffeenode-fillin'\n  text                    = FI.fill_in template, kwic_details\n  ###\n  HELPERS.provide_tmp_folder()\n  handler                ?= ->\n  layout_info             = HELPERS.new_layout_info source_route\n  source_locator          = layout_info[ 'source-locator']\n  tex_locator             = layout_info[ 'tex-locator']\n  tex_output              = njs_fs.createWriteStream tex_locator\n  ### TAINT should read MD source stream ###\n  text                    = njs_fs.readFileSync source_locator, encoding: 'utf-8'\n  #---------------------------------------------------------------------------------------------------------\n  tex_output.on 'close', =>\n    HELPERS.write_pdf layout_info, handler\n  #---------------------------------------------------------------------------------------------------------\n  input = TYPESETTER.create_html_readstream_from_mdx_text text\n  input\n    # .pipe @$transform_commands()\n    .pipe @$assemble_tex_events()\n    .pipe @$filter_tex()\n    # .pipe @$supply_cjk_markup()\n    .pipe @$insert_preamble()\n    .pipe @$insert_postscript()\n    .pipe D.$show()\n    .pipe tex_output\n  #---------------------------------------------------------------------------------------------------------\n  # D.resume input\n  input.resume()\n\n###\n#-----------------------------------------------------------------------------------------------------------\n@$transform_commands = ->\n  command_pattern = /^\\n?‡([^\\s][^\\n]*)\\n$/\n  return $ ( event, send ) =>\n    [ type, tail..., ]  = event\n    if ( type is 'text' ) and ( match = tail[ 0 ].match command_pattern )?\n      command = match[ 1 ]\n      match   = command.match /^(\\S+)\\s+(.+)$/\n      if match?\n        [ _, command, values, ] = match\n        send [ 'command', command, values, ]\n      else\n        send [ 'command', command, ]\n    else\n      send event\n###\n\n#-----------------------------------------------------------------------------------------------------------\n@$assemble_tex_events = ->\n  tag_stack               = []\n  within_multicol         = no\n  start_multicol_after    = null\n  add_newline_before_end  = null\n  list_level              = 0\n  #.........................................................................................................\n  return $ ( event, send, end ) =>\n    # if is_first_event\n    #   start_size 1\n    #   send [ 'doc', me, ]\n    #   is_first_event = no\n    #.......................................................................................................\n    if event?\n      [ type, tail..., ]  = event\n    #   ok                  = no\n      #.....................................................................................................\n      switch type\n        #- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\n        when 'command'\n          [ command, values, ] = tail\n          switch command\n            when 'new-document'\n              document_name = values\n              if within_multicol\n                send [ 'tex', '\\\\end{multicols}\\n\\n' ]\n                within_multicol = no\n              send [ 'tex', \"\\\\null\\\\newpage%‡#{command} #{document_name}‡\\n\" ]\n              # send [ 'tex', \"\\\\null\\\\newpage\\n\" ]\n              # send [ 'tex', \"\\n%‡#{command} #{document_name}\\n\\n\" ]\n            when 'newpage'\n              if within_multicol\n                send [ 'tex', '\\\\end{multicols}\\n\\n' ]\n                within_multicol = no\n              send [ 'tex', \"\\\\null\\\\newpage%1\\n\" ]\n            else\n              warn \"ignored command #{rpr event}\"\n        #- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\n        when 'text'\n          text = tail[ 0 ]\n          text = @fix_quotes  text\n          text = @escape_text text\n          send [ 'text', text, ]\n        #- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\n        when 'open-tag'\n          [ name, attributes, ] = tail\n          tag_stack.push name\n          #.................................................................................................\n          switch name\n    #         #...............................................................................................\n    #         when 'span'\n    #           if attributes[ 'class' ]? and ( match = attributes[ 'class' ].match /^size-([0-9]+)$/ )?\n    #             size = parseInt match[ 1 ], 10\n    #           else\n    #             size = get_size()\n    #           start_size size\n    #           ok = yes\n            #...............................................................................................\n            when 'newpage'\n              if within_multicol\n                send [ 'tex', '\\\\end{multicols}\\n\\n' ]\n                within_multicol = no\n              send [ 'tex', \"\\\\null\\\\newpage%2\\n\" ]\n            #...............................................................................................\n            when 'fullwidth'\n              if within_multicol\n                send [ 'tex', '\\\\end{multicols}\\n\\n' ]\n                within_multicol = no\n            #...............................................................................................\n            when 'h1'\n              if within_multicol\n                send [ 'tex', '\\\\end{multicols}\\n\\n' ]\n                within_multicol = no\n              # img_route = '/Volumes/Storage/temp/french-rule-swell-dash-englische-line/swell-dash.pdf'\n              # send [ 'tex', \"\\\\includegraphics[width=0.75\\\\linewidth]{#{img_route}}\", ]\n              # send [ 'tex', \"\\\\\\\\[3\\\\baselineskip]%\", ]\n              # send [ 'tex', '\\\\eline\\n', ]\n              # send [ 'tex', '\\n\\n', ]\n              send [ 'tex', \"\\\\jzrChapter{\", ]\n              # send [ 'tex', \"\\\\chapter{\", ]\n              add_newline_before_end  = name\n              start_multicol_after    = name\n            #...............................................................................................\n            when 'h2'\n              if within_multicol\n                send [ 'tex', '\\\\end{multicols}\\n\\n' ]\n                within_multicol = no\n              send [ 'tex', \"\\\\jzrSection{\", ]\n              start_multicol_after = name\n            #...............................................................................................\n            when 'h3'\n              send [ 'tex', \"\\\\subsection{\", ]\n            #...............................................................................................\n            when 'p'\n              unless within_multicol\n                send [ 'tex', '\\\\begin{multicols}{2}\\n' ]\n                within_multicol = yes\n              send [ 'tex', '\\n\\n', ]\n            #...............................................................................................\n            when 'br'\n              send [ 'tex', '\\\\\\\\', ]\n            #...............................................................................................\n            when 'blockquote'\n              send [ 'tex', '\\\\begin{blockquote}\\n', ]\n              # send [ 'tex', '\\\\begingroup\\n', ]\n              # send [ 'tex', '\\\\itshape\\n', ]\n            #...............................................................................................\n            when 'strong'\n              send [ 'tex', '\\\\bold{', ]\n            #...............................................................................................\n            when 'em'\n              send [ 'tex', '\\\\textit{', ]\n            #...............................................................................................\n            when 'ul'\n              # send [ 'tex', \"\\\\begin{itemize}\\n\", ]\n              send [ 'tex', \"\\\\begin{description}[leftmargin=0mm,itemsep=\\\\parskip,topsep=0mm]\" ]\n              # send [ 'tex', \"\\\\setlength{\\\\itemsep}{0mm}\\\\setlength{\\\\parskip}{0mm}\\\\setlength{\\\\parsep}{0mm}\\n\", ]\n              # send [ 'tex', \"\\\\setlength{\\\\itemsep}{\\\\parskip}\", ]\n              # send [ 'tex', \"\\\\setlength{\\\\topsep}{\\\\parskip}\\n\", ]\n              list_level += 1\n            #...............................................................................................\n            when 'li'\n              # send [ 'tex', \"\\\\item \", ]\n              send [ 'tex', \"\\\\item[¶] \", ]\n            # #...............................................................................................\n            # when 'span'\n            #   switch clasz = attributes[ 'class' ]\n            #     when 'fullwidth'\n            #       if within_multicol\n            #         send [ 'tex', '\\\\end{multicols}\\n\\n' ]\n            #         within_multicol                   = no\n            #         start_multicol_after              = 'fullwidth'\n            #         tag_stack[ tag_stack.length - 1 ] = 'fullwidth'\n            #     else\n            #       warn \"ignored HTML span of class #{rpr clasz}\"\n            #...............................................................................................\n            else\n              warn \"ignored opening HTML tag #{rpr name}\"\n        #- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\n        when 'close-tag'\n          if tag_stack.length < 1\n            warn \"empty tag stack\"\n          else\n            name = tag_stack.pop()\n            #...............................................................................................\n            if add_newline_before_end is name\n              send [ 'tex', '\\\\\\\\', ]\n              add_newline_before_end = null\n            #...............................................................................................\n            switch name\n              when 'h1', 'h2', 'h3', 'h4', 'h5', 'h6'\n                send [ 'tex', \"}\", ]\n                send [ 'tex', \"\\n\\n\", ]\n              when 'strong', 'em'\n                send [ 'tex', \"}\", ]\n              when 'blockquote'\n                send [ 'tex', \"\\\\end{blockquote}\\n\\n\", ]\n                # send [ 'tex', \"\\\\endgroup\\n\\n\", ]\n              when 'p', 'li', 'br', 'newpage', 'fullwidth'\n                null\n              when 'ul'\n                # send [ 'tex', \"\\\\end{itemize}\", ]\n                send [ 'tex', \"\\\\end{description}\", ]\n                list_level -= 1\n              else\n                warn \"ignored closing HTML tag #{rpr name}\"\n            #...............................................................................................\n            ### TAINT places multicols between h1, h2 etc ###\n            if start_multicol_after is name\n              send [ 'tex', '\\\\begin{multicols}{2}\\n' ]\n              start_multicol_after  = null\n              within_multicol       = yes\n        #- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\n        when 'end'\n          send [ 'tex', '\\\\end{multicols}' ] if within_multicol\n        #- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\n        else\n          warn \"ignored event #{rpr event}\"\n    #.......................................................................................................\n    if end?\n      end()\n\n#-----------------------------------------------------------------------------------------------------------\n@$filter_tex = ->\n  return $ ( event, send ) =>\n    [ type, tail..., ] = event\n    switch type\n      when 'text', 'tex'\n        send tail[ 0 ]\n      else\n        send.error \"unknown event type #{rpr type}\"\n\n#-----------------------------------------------------------------------------------------------------------\n@$insert_preamble = ->\n  return D.$on_start ( send ) =>\n    send \"\"\"\n      \\\\documentclass[a4paper,twoside]{book}\n      \\\\usepackage{jzr2014}\n      \\\\usepackage{jzr2015-article}\n      \\\\begin{document}\n      \"\"\"\n\n#-----------------------------------------------------------------------------------------------------------\n@$insert_postscript = ->\n  return D.$on_end ( send, end ) =>\n    send \"\"\"\n      \\\\end{document}\\n\n      \"\"\"\n    end()\n\n#-----------------------------------------------------------------------------------------------------------\n@fix_quotes = ( text ) ->\n  R = text\n  R = R.replace /'([^\\s]+)’/g, '‘$1’'\n  return R\n\n#-----------------------------------------------------------------------------------------------------------\n@escape_text = ( text ) ->\n  R = text\n  R = R.replace /‰/g, '\\\\permille{}'\n  R = R.replace /&amp;/g, '\\\\&'\n  return R\n\n#-----------------------------------------------------------------------------------------------------------\n@$supply_cjk_markup = ->\n  tag_stack = []\n  #.........................................................................................................\n  return $ ( event, send ) =>\n    [ type, tail..., ] = event\n    return send event unless type is 'text'\n    text  = tail[ 0 ]\n    tex   = H1.cjk_as_tex_text text\n    # tex   = tex.replace /\\\\latin\\{([^]+)\\}/g, '$1'\n    send [ 'tex', tex, ]\n\n\n\n############################################################################################################\nunless module.parent?\n  @pdf_from_md 'texts/A-Permuted-Index-of-Chinese-Characters/index.md'\n\n\n"]}