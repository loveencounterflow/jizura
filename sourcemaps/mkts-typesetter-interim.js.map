{"version":3,"sources":["mkts-typesetter-interim.coffee"],"names":[],"mappings":"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","file":"mkts-typesetter-interim.js","sourceRoot":"/source/","sourcesContent":["\n\n\n\n\n############################################################################################################\nnjs_path                  = require 'path'\nnjs_fs                    = require 'fs'\n#...........................................................................................................\nCND                       = require 'cnd'\nrpr                       = CND.rpr\nbadge                     = 'JIZURA/MKTS-interim'\nlog                       = CND.get_logger 'plain',     badge\ninfo                      = CND.get_logger 'info',      badge\nwhisper                   = CND.get_logger 'whisper',   badge\nalert                     = CND.get_logger 'alert',     badge\ndebug                     = CND.get_logger 'debug',     badge\nwarn                      = CND.get_logger 'warn',      badge\nhelp                      = CND.get_logger 'help',      badge\nurge                      = CND.get_logger 'urge',      badge\necho                      = CND.echo.bind CND\n#...........................................................................................................\nsuspend                   = require 'coffeenode-suspend'\nstep                      = suspend.step\n#...........................................................................................................\nD                         = require 'pipedreams'\n$                         = D.remit.bind D\n$async                    = D.remit_async.bind D\n#...........................................................................................................\nASYNC                     = require 'async'\n#...........................................................................................................\nƒ                         = CND.format_number.bind CND\nHELPERS                   = require './HELPERS'\nTYPO                      = HELPERS[ 'TYPO' ]\noptions                   = require './options'\n\n\n#-----------------------------------------------------------------------------------------------------------\n@pdf_from_md = ( source_route, handler ) ->\n  ###\n  FI = require 'coffeenode-fillin'\n  text                    = FI.fill_in template, kwic_details\n  ###\n  HELPERS.provide_tmp_folder()\n  handler                ?= ->\n  layout_info             = HELPERS.new_layout_info source_route\n  source_locator          = layout_info[ 'source-locator']\n  tex_locator             = layout_info[ 'tex-locator']\n  tex_output              = njs_fs.createWriteStream tex_locator\n  ### TAINT should read MD source stream ###\n  text                    = njs_fs.readFileSync source_locator, encoding: 'utf-8'\n  #---------------------------------------------------------------------------------------------------------\n  tex_output.on 'close', =>\n    tasks = []\n    tasks.push ( done ) -> HELPERS.write_pdf layout_info, done\n    ### TAINT put into HELPERS ###\n    tasks.push ( done ) ->\n      html          = TYPO.get_meta input, 'html'\n      html_locator  = HELPERS.tmp_locator_for_extension layout_info, 'html'\n      help \"writing HTML to #{html_locator}\"\n      njs_fs.writeFile html_locator, html, done\n    ASYNC.parallel tasks, handler\n  #---------------------------------------------------------------------------------------------------------\n  input = TYPO.create_html_readstream_from_md text\n  input\n    # .pipe @$transform_commands()\n    .pipe TYPO.$resolve_html_entities()\n    .pipe TYPO.$fix_typography_for_tex()\n    .pipe D.$show()\n    .pipe @$assemble_tex_events()\n    .pipe @$filter_tex()\n    .pipe @$insert_preamble layout_info\n    .pipe @$insert_postscript()\n    .pipe tex_output\n  #---------------------------------------------------------------------------------------------------------\n  # D.resume input\n  input.resume()\n\n###\n#-----------------------------------------------------------------------------------------------------------\n@$transform_commands = ->\n  command_pattern = /^\\n?‡([^\\s][^\\n]*)\\n$/\n  return $ ( event, send ) =>\n    [ type, tail..., ]  = event\n    if ( type is 'text' ) and ( match = tail[ 0 ].match command_pattern )?\n      command = match[ 1 ]\n      match   = command.match /^(\\S+)\\s+(.+)$/\n      if match?\n        [ _, command, values, ] = match\n        send [ 'command', command, values, ]\n      else\n        send [ 'command', command, ]\n    else\n      send event\n###\n\n#-----------------------------------------------------------------------------------------------------------\n@$assemble_tex_events = ->\n  tag_stack               = []\n  within_multicol         = no\n  start_multicol_after    = null\n  add_newline_before_end  = null\n  list_level              = 0\n  within_keeplines        = no\n  within_pre              = no\n  within_single_column    = no\n  #.........................................................................................................\n  return $ ( event, send, end ) =>\n    #.......................................................................................................\n    if event?\n      [ type, tail..., ]  = event\n    #   ok                  = no\n      #.....................................................................................................\n      switch type\n        #- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\n        when 'command'\n          [ command, values, ] = tail\n          switch command\n            when 'new-document'\n              send [ 'tex', '% ### MKTS ∆∆∆new-document ###\\n', ]\n              document_name = values\n              if within_multicol\n                send [ 'tex', '\\\\end{multicols}' ]\n                within_multicol = no\n              send [ 'tex', \"\\\\null\\\\newpage%‡#{command} #{document_name}‡\\n\" ]\n            when 'new-page'\n              send [ 'tex', '% ### MKTS ∆∆∆new-page ###\\n', ]\n              if within_multicol\n                send [ 'tex', '\\\\end{multicols}' ]\n                within_multicol = no\n              send [ 'tex', \"\\\\null\\\\newpage%1\\n\" ]\n            else\n              warn \"ignored command #{rpr event}\"\n        #- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\n        when 'comment'\n          for line in tail[ 0 ].split '\\n'\n            send [ 'tex', \"% #{line}\\n\", ]\n        #- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\n        when 'text'\n          text = tail[ 0 ]\n          # if within_keeplines\n          #   text = text.replace /\\n\\n/g, '~\\\\\\\\\\n'\n          if within_pre\n            text = text.replace /\\u0020/g, '\\u00a0'\n          send [ 'text', text, ]\n        #- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\n        when 'start-region'\n          [ name, ] = tail\n          switch name\n            #...............................................................................................\n            when 'single-column'\n              send [ 'tex', '% ### MKTS @@@single-column ###\\n', ]\n              debug '©x1ESw', '---------------------------single-column('\n              within_single_column = yes\n              if within_multicol\n                send [ 'tex', '\\\\end{multicols}' ]\n                within_multicol = no\n              send [ 'tex', '\\n\\n', ]\n            #...............................................................................................\n            when 'keep-lines'\n              send [ 'tex', '% ### MKTS @@@keep-lines ###\\n', ]\n              ### TAINT differences between pre and keep-lines? ###\n              debug '©x1ESw', '---------------------------keep-lines('\n              within_pre        = yes\n              within_keeplines  = yes\n              send [ 'tex', \"\\\\begingroup\\\\obeyalllines{}\", ]\n              # ignore_next_nl          = yes\n            #...............................................................................................\n            else\n              warn \"ignored start-region #{rpr name}\"\n        #- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\n        when 'end-region'\n          send [ 'tex', '% ### MKTS @@@ ###\\n', ]\n          [ name, ] = tail\n          switch name\n            #...............................................................................................\n            when 'single-column'\n              debug '©x1ESw', ')single-column---------------------------'\n              send [ 'tex', '\\\\begin{multicols}{2}\\n' ]\n              within_multicol       = yes\n              within_single_column  = no\n            #...............................................................................................\n            when 'keep-lines'\n              debug '©x1ESw', ')keep-lines---------------------------'\n              send [ 'tex', \"\\\\endgroup{}\\n\", ]\n              # send [ 'tex', \"\\n\\n\", ]\n              within_keeplines  = no\n              within_pre        = no\n            #...............................................................................................\n            else\n              warn \"ignored start-region #{rpr name}\"\n        #- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\n        when 'open-tag'\n          [ name, attributes, ] = tail\n          tag_stack.push name\n          #.................................................................................................\n          switch name\n            #...............................................................................................\n            # when 'div'\n            #   ### modify tag stack so we know which tag was popped: ###\n            #   clasz                             = attributes[ 'class' ]\n            #   tag_stack[ tag_stack.length - 1 ] = clasz\n            #   switch clasz\n            #     when 'keep-lines'\n            #       within_keeplines        = yes\n            #       ignore_next_nl          = yes\n            #     else\n            #       warn \"ignored unknown div class #{rpr clasz}\"\n            #...............................................................................................\n            when 'newpage'\n              if within_multicol\n                send [ 'tex', '\\\\end{multicols}' ]\n                within_multicol = no\n              send [ 'tex', \"\\\\null\\\\newpage%2\\n\" ]\n            #...............................................................................................\n            when 'fullwidth'\n              if within_multicol\n                send [ 'tex', '\\\\end{multicols}' ]\n                within_multicol = no\n            #...............................................................................................\n            when 'h1'\n              if within_multicol\n                send [ 'tex', '\\\\end{multicols}' ]\n                within_multicol = no\n              # img_route = '/Volumes/Storage/temp/french-rule-swell-dash-englische-line/swell-dash.pdf'\n              # send [ 'tex', \"\\\\includegraphics[width=0.75\\\\linewidth]{#{img_route}}\", ]\n              # send [ 'tex', \"\\\\\\\\[3\\\\baselineskip]%\", ]\n              # send [ 'tex', '\\\\eline\\n', ]\n              # send [ 'tex', '\\n\\n', ]\n              send [ 'tex', \"\\\\jzrChapter{\", ]\n              # send [ 'tex', \"\\\\chapter{\", ]\n              add_newline_before_end  = name\n              start_multicol_after    = name\n            #...............................................................................................\n            when 'h2'\n              if within_multicol\n                send [ 'tex', '\\\\end{multicols}' ]\n                within_multicol = no\n              send [ 'tex', \"\\\\jzrSection{\", ]\n              start_multicol_after = name\n            #...............................................................................................\n            when 'h3'\n              send [ 'tex', \"\\\\subsection{\", ]\n            #...............................................................................................\n            when 'h4'\n              ### TAINT subsection or deeper? ###\n              send [ 'tex', \"\\\\subsection{\", ]\n            #...............................................................................................\n            when 'h5', 'h6'\n              send [ 'tex', \"\\\\subsection{\", ]\n            #...............................................................................................\n            when 'p'\n              if ( not within_single_column ) and ( not within_multicol )\n                send [ 'tex', '\\\\begin{multicols}{2}\\n' ]\n                within_multicol = yes\n              send [ 'tex', '\\n', ]\n            #...............................................................................................\n            when 'br'\n              send [ 'tex', '\\\\\\\\', ]\n            #...............................................................................................\n            when 'blockquote'\n              send [ 'tex', '\\\\begin{blockquote}\\n', ]\n              # send [ 'tex', '\\\\begingroup\\n', ]\n              # send [ 'tex', '\\\\itshape\\n', ]\n            #...............................................................................................\n            when 'strong'\n              send [ 'tex', '\\\\bold{', ]\n            #...............................................................................................\n            when 'em'\n              send [ 'tex', '\\\\textit{', ]\n            #...............................................................................................\n            when 'ul'\n              # send [ 'tex', \"\\\\begin{itemize}\\n\", ]\n              send [ 'tex', \"\\\\begin{description}[leftmargin=0mm,itemsep=\\\\parskip,topsep=0mm]\" ]\n              # send [ 'tex', \"\\\\setlength{\\\\itemsep}{0mm}\\\\setlength{\\\\parskip}{0mm}\\\\setlength{\\\\parsep}{0mm}\\n\", ]\n              # send [ 'tex', \"\\\\setlength{\\\\itemsep}{\\\\parskip}\", ]\n              # send [ 'tex', \"\\\\setlength{\\\\topsep}{\\\\parskip}\\n\", ]\n              list_level += 1\n            #...............................................................................................\n            when 'ol'\n              ### TAINT doing an unordered list here ###\n              send [ 'tex', \"\\\\begin{enumerate}\\n\", ]\n              list_level += 1\n            #...............................................................................................\n            when 'li'\n              # send [ 'tex', \"\\\\item \", ]\n              # send [ 'tex', \"\\\\item[¶] \", ]\n              send [ 'tex', \"\\\\item[—] \", ]\n            #...............................................................................................\n            when 'pre'\n              # send [ 'tex', \"\\n\\n\", ]\n              send [ 'tex', \"\\\\begingroup\\\\obeyalllines\\n\", ]\n              within_pre        = yes\n              within_keeplines  = yes\n            #...............................................................................................\n            when 'code'\n              # send [ 'tex', \"\\\\begingroup\\\\setCodeLatin\\n\", ]\n              # send [ 'tex', \"\\\\begingroup\\\\jzrFontSunXA\\n\", ]\n              send [ 'tex', \"\\\\begingroup\\\\jzrFontSourceCodePro{}\", ]\n            #...............................................................................................\n            else\n              warn \"ignored opening HTML tag #{rpr name}\"\n        #- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\n        when 'close-tag'\n          if tag_stack.length < 1\n            warn \"empty tag stack\"\n          else\n            ### TAINT wrongly pops tags that got omitted ###\n            name = tag_stack.pop()\n            #...............................................................................................\n            if add_newline_before_end is name\n              send [ 'tex', '\\\\\\\\', ]\n              add_newline_before_end = null\n            #...............................................................................................\n            switch name\n              when 'h1', 'h2', 'h3', 'h4', 'h5', 'h6'\n                send [ 'tex', \"}\", ]\n                send [ 'tex', \"\\n\\n\", ]\n              when 'strong', 'em'\n                send [ 'tex', \"}\", ]\n              when 'blockquote'\n                send [ 'tex', \"\\\\end{blockquote}\\n\\n\", ]\n                # send [ 'tex', \"\\\\endgroup\\n\\n\", ]\n              when 'p', 'li', 'br', 'newpage', 'fullwidth'\n                null\n              when 'pre'\n                send [ 'tex', \"\\\\endgroup\\n\", ]\n                within_keeplines  = no\n                within_pre        = no\n              when 'code'\n                send [ 'tex', \"\\\\endgroup{}\", ]\n              when 'ul', 'ol'\n                send [ 'tex', \"\\\\end{enumerate}\", ]\n                # send [ 'tex', \"\\\\end{description}\", ]\n                list_level += -1\n              else\n                warn \"ignored closing HTML tag #{rpr name}\"\n            #...............................................................................................\n            ### TAINT places multicols between h1, h2 etc ###\n            if start_multicol_after is name\n              send [ 'tex', '\\\\begin{multicols}{2}\\n' ]\n              start_multicol_after  = null\n              within_multicol       = yes\n        #- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\n        when 'end'\n          send [ 'tex', '\\\\end{multicols}' ] if within_multicol\n        #- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\n        else\n          warn \"ignored event #{rpr event}\"\n    #.......................................................................................................\n    if end?\n      end()\n\n#-----------------------------------------------------------------------------------------------------------\n@$filter_tex = ->\n  return $ ( event, send ) =>\n    [ type, tail..., ] = event\n    switch type\n      when 'text', 'tex'\n        send tail[ 0 ]\n      else\n        send.error \"unknown event type #{rpr type}\"\n\n#-----------------------------------------------------------------------------------------------------------\n@$insert_preamble = ( layout_info ) ->\n  return D.$on_start ( send ) =>\n    tex_inputs_home = layout_info[ 'tex-inputs-home' ]\n    ### TAINT should escape locators to prevent clashes with LaTeX syntax ###\n    send \"\"\"\n      \\\\documentclass[a4paper,twoside]{book}\n      \\\\usepackage{#{njs_path.join tex_inputs_home, 'mkts2015-main'}}\n      \\\\usepackage{#{njs_path.join tex_inputs_home, 'mkts2015-fonts'}}\n      \\\\usepackage{#{njs_path.join tex_inputs_home, 'mkts2015-article'}}\n      \\\\begin{document}\n      \"\"\"\n\n#-----------------------------------------------------------------------------------------------------------\n@$insert_postscript = ->\n  return D.$on_end ( send, end ) =>\n    send \"\"\"\n      \\\\end{document}\\n\n      \"\"\"\n    end()\n\n\n\n############################################################################################################\nunless module.parent?\n  # @pdf_from_md 'texts/A-Permuted-Index-of-Chinese-Characters/index.md'\n  @pdf_from_md 'texts/demo/demo.md'\n\n  # debug '©nL12s', TYPO.as_tex_text '亻龵helo さしすサシス 臺灣國語Ⓒ, Ⓙ, Ⓣ𠀤𠁥&jzr#e202;'\n  # debug '©nL12s', TYPO.as_tex_text 'helo さし'\n\n\n"]}